<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boxe Tool - Gestion Présences 0.14</title>
</head>
<body>

    <!-- ANNONCES -->
    <h1>Annonces :</h1>
    <div id="annonceResult" style="margin-top:10px; font-weight:bold;">
        <!-- Embeded Code -->
        <iframe src="https://www.facebook.com/plugins/post.php?href=https%3A%2F%2Fwww.facebook.com%2Fpermalink.php%3Fstory_fbid%3Dpfbid02ha57MXqWthuKQzF86hWdRqqbwT7t4ZMuzVREBWLtBB12kRZiJwu6kaCjhEMzaHxkl%26id%3D61575936127767&show_text=true&width=500"
                width="500"
                height="683"
                style="border:none;overflow:hidden"
                scrolling="no"
                frameborder="0"
                allowfullscreen="true"
                allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share">
        </iframe>
    </div>

    <!-- CALENDRIER COMPÉTITIONS -->
    <h1 style="margin-top:30px;">Calendrier compétitions</h1>
    <div id="calendrierCompetitions" style="margin-top:10px;">
        À venir…
    </div>

    <!-- ACTION PRINCIPALE -->
    <h1 style="margin-top:40px;">Enregistrer la présence d'un boxeur 0.14</h1>

    <label for="boxeurSelect">Choisissez un boxeur :</label>
    <select id="boxeurSelect">
        <option value="">-- Sélectionnez --</option>
    </select>

    <div style="margin-top:10px;">
        <button data-statut="Present">Présent</button>
        <button data-statut="Retard">Retard</button>
        <button data-statut="Blessure">Blessure</button>
        <button data-statut="Exclusion">Exclu</button>
        <button id="supprimerBtn" style="margin-left:10px;">Absent</button>
    </div>

    <!-- RESULT ACTION -->
    <div id="result" style="margin-top:20px; font-weight:bold;"></div>

    <script>
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4cmZydG1haGZ5bXd1eGdwcnNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MDUzMTksImV4cCI6MjA4MDk4MTMxOX0.ge8mWR-cejDTxPC2zTm-Xl1eBma1KWro8-SEzM8zblk';
        const SUPABASE_URL = 'https://uxrfrtmahfymwuxgprsd.supabase.co';

        // --- Charger les boxeurs ---
        async function loadBoxeursSelect() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/Boxeurs?select=id,LastName,FirstName`, {
                    headers: {
                        "apikey": API_KEY,
                        "Authorization": "Bearer " + API_KEY
                    }
                });
                const data = await res.json();
                const select = document.getElementById('boxeurSelect');

                data.forEach(boxeur => {
                    const option = document.createElement('option');
                    option.value = boxeur.id;
                    option.textContent = `${boxeur.LastName} ${boxeur.FirstName}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Erreur loadBoxeursSelect :", error);
                document.getElementById('result').innerText = "Erreur lors du chargement des boxeurs";
            }
        }

        // --- Enregistrer présence (delete + insert) ---
        async function enregistrerPresence(boxeurId, statut) {
            try {
                const today = new Date().toISOString().split('T')[0];

                await fetch(`${SUPABASE_URL}/rest/v1/Presences?boxeur_id=eq.${boxeurId}&date_cours=eq.${today}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': 'Bearer ' + API_KEY
                    }
                });

                const res = await fetch(`${SUPABASE_URL}/rest/v1/Presences`, {
                    method: 'POST',
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': 'Bearer ' + API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        boxeur_id: boxeurId,
                        date_cours: today,
                        statut: statut
                    })
                });

                if (!res.ok) throw new Error('Erreur insertion présence');

                document.getElementById('result').innerText = `Présence enregistrée : ${statut}`;
            } catch (err) {
                console.error(err);
                document.getElementById('result').innerText = 'Erreur lors de l\'enregistrement';
            }
        }

        // --- Supprimer présence ---
        async function supprimerPresence(boxeurId) {
            try {
                const today = new Date().toISOString().split('T')[0];

                const res = await fetch(`${SUPABASE_URL}/rest/v1/Presences?boxeur_id=eq.${boxeurId}&date_cours=eq.${today}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': 'Bearer ' + API_KEY
                    }
                });

                document.getElementById('result').innerText = res.ok
                    ? 'Présence annulée'
                    : 'Erreur lors de l\'annulation';
            } catch (err) {
                console.error(err);
                document.getElementById('result').innerText = 'Erreur lors de l\'annulation';
            }
        }

        // --- Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            loadBoxeursSelect();

            document.querySelectorAll('button[data-statut]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const select = document.getElementById('boxeurSelect');
                    if (!select.value) {
                        alert('Veuillez choisir un boxeur');
                        return;
                    }
                    enregistrerPresence(select.value, btn.dataset.statut);
                });
            });

            document.getElementById('supprimerBtn').addEventListener('click', () => {
                const select = document.getElementById('boxeurSelect');
                if (!select.value) {
                    alert('Veuillez choisir un boxeur');
                    return;
                }
                supprimerPresence(select.value);
            });
        });
    </script>

</body>
</html>
