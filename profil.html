<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boxe Tool Minimal 0.48</title>

    <script defer>
        const SUPABASE_URL_BOXEURS = 'https://uxrfrtmahfymwuxgprsd.supabase.co/rest/v1/Boxeurs?select=id,LastName,FirstName';
        const SUPABASE_URL_PRESENCES = 'https://uxrfrtmahfymwuxgprsd.supabase.co/rest/v1/Presences';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4cmZydG1haGZ5bXd1eGdwcnNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MDUzMTksImV4cCI6MjA4MDk4MTMxOX0.ge8mWR-cejDTxPC2zTm-Xl1eBma1KWro8-SEzM8zblk';

        // --- Fetch boxeurs ---
        async function getBoxeurs() {
            try {
                const res = await fetch(SUPABASE_URL_BOXEURS, {
                    headers: { "apikey": API_KEY, "Authorization": "Bearer " + API_KEY }
                });
                return await res.json();
            } catch (error) {
                console.error("Erreur fetch Supabase :", error);
                return [];
            }
        }

        // --- Fetch présences par statut ---
        async function getPresencesBoxeur(boxeurId, month, statut) {
            if (!boxeurId || !month || !statut) return 0;

            const startMonth = month + "-01";
            const [year, m] = month.split("-");
            const endDay = new Date(year, parseInt(m), 0).getDate();
            const endMonth = `${month}-${String(endDay).padStart(2, '0')}`;

            // Correct field: 'statut' instead of 'statu'
            const url = `${SUPABASE_URL_PRESENCES}?boxeur_id=eq.${boxeurId}&date_cours=gte.${startMonth}&date_cours=lte.${endMonth}&statut=eq.${statut}&select=id`;

            try {
                const res = await fetch(url, {
                    headers: { "apikey": API_KEY, "Authorization": "Bearer " + API_KEY }
                });
                const data = await res.json();
                return Array.isArray(data) ? data.length : 0;
            } catch (err) {
                console.error(`Erreur fetch Presences ${statut} :`, err);
                return 0;
            }
        }

        // --- Init select et listener ---
        async function initSelectBoxeur() {
            const select = document.getElementById('boxeurSelect');
            const monthSelect = document.getElementById('monthSelect');
            const resultID = document.getElementById('lineID');
            const resultNom = document.getElementById('lineNom');
            const resultPrenom = document.getElementById('linePrenom');
            const resultPresences = document.getElementById('linePresences');

            const boxeurs = await getBoxeurs();
            boxeurs.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.dataset.lastname = b.LastName;
                opt.dataset.firstname = b.FirstName;
                opt.textContent = `${b.LastName} ${b.FirstName}`;
                select.appendChild(opt);
            });

            const now = new Date();
            monthSelect.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            async function updatePresences() {
                const boxeurId = select.value;
                const month = monthSelect.value;
                if (!boxeurId || !month) {
                    resultPresences.innerText = "";
                    return;
                }

                const present = await getPresencesBoxeur(boxeurId, month, "Present");
                const retard = await getPresencesBoxeur(boxeurId, month, "Retard");
                const blessure = await getPresencesBoxeur(boxeurId, month, "Blessure");
                const exclu = await getPresencesBoxeur(boxeurId, month, "Exclusion");

                resultPresences.innerHTML = `
                        Présent : ${present || 0} <br>
                        Retard : ${retard || 0} <br>
                        Blessure : ${blessure || 0} <br>
                        Exclu : ${exclu || 0}
                    `;
            }

            select.addEventListener('change', () => {
                const opt = select.options[select.selectedIndex];
                if (!opt || !opt.value) {
                    resultID.innerText = "";
                    resultNom.innerText = "";
                    resultPrenom.innerText = "";
                    resultPresences.innerText = "";
                    return;
                }
                resultID.innerText = "ID : " + opt.value;
                resultNom.innerText = "Nom : " + opt.dataset.lastname;
                resultPrenom.innerText = "Prénom : " + opt.dataset.firstname;
                updatePresences();
            });

            monthSelect.addEventListener('change', updatePresences);
        }

        window.addEventListener("DOMContentLoaded", () => {
            initSelectBoxeur();
        });
    </script>
</head>

<body>
    <h1>Liste des Boxeurs</h1>

    <h2>Profil des boxeurs</h2>
    <label for="boxeurSelect">Choisissez un boxeur :</label>
    <select id="boxeurSelect">
        <option value="">-- Sélectionnez --</option>
    </select>

    <div id="selectedResult" style="margin-top:15px; font-weight:bold;">
        <div id="lineID"></div>
        <div id="lineNom"></div>
        <div id="linePrenom"></div>
        <label for="monthSelect">Sélectionnez un mois :</label>
        <input type="month" id="monthSelect" style="margin-left:5px;">
        <div id="linePresences"></div>
    </div>
</body>
</html>