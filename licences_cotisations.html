<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boxe Tool - Licences & Cotisations</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #aaa;
            padding: 6px 10px;
            text-align: left;
        }

        th {
            background-color: #f0f0f0;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <h1>Gestion Licences & Cotisations</h1>

    <!-- Statut global -->
    <div style="margin-bottom:20px;">
        <h2>Statut global : <span id="overallStatus">‚Äî</span></h2>
    </div>

    <!-- S√©lection boxeur -->
    <label for="boxeurSelect">Choisissez un boxeur :</label>
    <select id="boxeurSelect">
        <option value="">-- S√©lectionnez --</option>
    </select>

    <!-- Section licences -->
    <div style="margin-top:15px;">
        <h3>Licence</h3>
        <label>
            Type:
            <select id="licencetype">
                <option value="">-- S√©lectionnez --</option>
                <option value="Boxe Anglaise">Boxe Anglaise</option>
                <option value="Boxe Fran√ßaise">Boxe Fran√ßaise</option>
                <option value="En Cours">En Cours</option>
            </select>
        </label>
        <br>
        <label id="labelRegDate">
            Date r√®glement:
            <input type="date" id="licenceregdate">
        </label>
        <br>
        <label>Status: <span id="licencestatus"></span></label>
        <br>
        <label>Date expiration calcul√©e: <span id="licenceexpiredate" data-prev=""></span></label>
    </div>

    <!-- Section cotisations -->
    <div style="margin-top:15px;">
        <h3>Cotisation</h3>
        <label>
            Type (s√©ance / mois) :
            <select id="cotisationtype">
                <option value="">‚Äî choisir ‚Äî</option>
                <option value="3">3‚Ç¨</option>
                <option value="1">1 mois</option>
                <option value="5">5 mois</option>
                <option value="10">10 mois</option>
            </select>
        </label>
        <br>
        <label>Pay√©: <span id="cotisationstatus"></span></label>
        <br>
        <label>
            Date paiement:
            <input type="date" id="cotisationpaymentdate">
        </label>
        <br>
        <label>
            Date √©ch√©ance:
            <input type="date" id="cotisationexpiredate" readonly>
        </label>
        <br>
    </div>

    <div style="margin-top:10px;">
        <button id="saveBtn">Enregistrer</button>
    </div>

    <div id="result" style="margin-top:20px; font-weight:bold;"></div>

    <!-- Tableau boxeurs pas en ordre -->
    <div style="margin-top:20px;">
        <h2>Boxeurs pas en ordre :</h2>
        <table id="notInOrderTable">
            <thead>
                <tr>
                    <th>Nom</th>
                    <th>Licence</th>
                    <th>Cotisation</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4cmZydG1haGZ5bXd1eGdwcnNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MDUzMTksImV4cCI6MjA4MDk4MTMxOX0.ge8mWR-cejDTxPC2zTm-Xl1eBma1KWro8-SEzM8zblk';
        const SUPABASE_URL = 'https://uxrfrtmahfymwuxgprsd.supabase.co';

        // --- Utilitaires ---
        function calculateLicenceExpireDate(regDateStr) {
            if (!regDateStr) return '';
            const regDate = new Date(regDateStr);
            regDate.setFullYear(regDate.getFullYear() + 1);
            return regDate.toISOString().split('T')[0];
        }

        function getLicenceStatusMessage(regDateStr) {
            if (!regDateStr) return "En cours";
            const today = new Date().toISOString().split('T')[0];
            const expireDate = calculateLicenceExpireDate(regDateStr);
            if (regDateStr > today) return `Valide √† partir du ${regDateStr}`;
            return expireDate >= today ? "Valide" : "Expir√©e";
        }

        function getCotisationStatusMessage(paymentDateStr, expireStr) {
            if (!paymentDateStr) return "Non pay√©";
            const today = new Date().toISOString().split('T')[0];
            if (paymentDateStr > today) return `Pay√© √† partir du ${paymentDateStr}`;
            return (expireStr >= today) ? "Pay√©" : "Non pay√©";
        }

        // --- Chargement boxeurs ---
        async function loadBoxeurs() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/Boxeurs?select=id,LastName,FirstName`, {
                    headers: { "apikey": API_KEY, "Authorization": "Bearer " + API_KEY }
                });
                const data = await res.json();
                const select = document.getElementById('boxeurSelect');
                select.innerHTML = '<option value="">-- S√©lectionnez --</option>';
                data.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.textContent = `${b.LastName} ${b.FirstName}`;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error(e);
                document.getElementById('result').innerText = "Erreur chargement boxeurs";
            }
        }

        // --- Load licence & cotisation ---
        async function loadLicenceCotisation(boxeurId) {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/licencesetcotisations?boxeur_id=eq.${boxeurId}`, {
                    headers: { "apikey": API_KEY, "Authorization": "Bearer " + API_KEY }
                });
                const data = await res.json();
                if (data.length > 0) {
                    const l = data[0];
                    document.getElementById('licencetype').value = l.licencetype || '';
                    document.getElementById('licenceregdate').value = l.licenceregdate || '';
                    const lastExpire = l.licenceregdate ? calculateLicenceExpireDate(l.licenceregdate) : '';
                    document.getElementById('licenceexpiredate').setAttribute('data-prev', lastExpire);
                    updateLicenceStatus();

                    document.getElementById('cotisationtype').value = l.cotisationtype || '';
                    document.getElementById('cotisationpaymentdate').value = l.cotisationpaymentdate || '';
                    updateCotisationStatus();
                } else clearForm();
            } catch (e) {
                console.error(e);
            }
        }

        function clearForm() {
            document.getElementById('licencetype').value = '';
            document.getElementById('licenceregdate').value = '';
            document.getElementById('licencestatus').innerText = '';
            document.getElementById('licenceexpiredate').innerText = '';
            document.getElementById('cotisationtype').value = '';
            document.getElementById('cotisationstatus').innerText = '';
            document.getElementById('cotisationpaymentdate').value = '';
            document.getElementById('cotisationexpiredate').value = '';
            updateOverallStatus();
        }

        function updateLicenceStatus() {
            const type = document.getElementById('licencetype').value;
            const regDate = document.getElementById('licenceregdate').value;
            const expireSpan = document.getElementById('licenceexpiredate');
            const labelRegDate = document.getElementById('labelRegDate');

            if (type === "En Cours") {
                labelRegDate.style.display = 'none';
                document.getElementById('licencestatus').innerText = "En cours";
                expireSpan.innerText = expireSpan.getAttribute('data-prev') || '';
            } else {
                labelRegDate.style.display = 'inline';
                expireSpan.innerText = calculateLicenceExpireDate(regDate);
                document.getElementById('licencestatus').innerText = getLicenceStatusMessage(regDate);
            }

            updateCotisationStatus();
            updateOverallStatus();
        }

        function updateCotisationStatus() {
            const type = parseInt(document.getElementById('cotisationtype').value) || 0;
            const today = new Date().toISOString().split('T')[0];
            const paymentDateInput = document.getElementById('cotisationpaymentdate');

            let expireStr = '';
            if (type === 3) {
                const paymentDate = paymentDateInput.value || today;
                expireStr = paymentDate;
                paymentDateInput.value = paymentDate;
            } else if (type > 0 && paymentDateInput.value) {
                const expire = new Date(paymentDateInput.value);
                expire.setMonth(expire.getMonth() + type);
                expireStr = expire.toISOString().split('T')[0];
            }

            document.getElementById('cotisationexpiredate').value = expireStr;
            document.getElementById('cotisationstatus').innerText = getCotisationStatusMessage(paymentDateInput.value, expireStr);

            updateOverallStatus();
        }

        function updateOverallStatus() {
            const licenceText = document.getElementById('licencestatus').innerText;
            const cotisationText = document.getElementById('cotisationstatus').innerText;

            const licenceFutureMatch = licenceText.match(/Valide √† partir du (\d{4}-\d{2}-\d{2})/);
            const cotisationFutureMatch = cotisationText.match(/Pay√© √† partir du (\d{4}-\d{2}-\d{2})/);

            if (licenceFutureMatch && cotisationFutureMatch) {
                const futureDate = licenceFutureMatch[1] > cotisationFutureMatch[1] ? licenceFutureMatch[1] : cotisationFutureMatch[1];
                document.getElementById('overallStatus').innerText = `En ordre √† partir du ${futureDate}`;
            } else if (licenceFutureMatch) {
                document.getElementById('overallStatus').innerText = `En ordre √† partir du ${licenceFutureMatch[1]}`;
            } else if (cotisationFutureMatch) {
                document.getElementById('overallStatus').innerText = `En ordre √† partir du ${cotisationFutureMatch[1]}`;
            } else {
                document.getElementById('overallStatus').innerText =
                    (licenceText === "Valide" && cotisationText === "Pay√©") ? "En ordre" : "Pas en ordre";
            }
        }

        // --- Enregistrement licence & cotisation ---
        async function saveLicenceCotisation(boxeurId) {
            try {
                const payload = {
                    boxeur_id: boxeurId,
                    licencetype: document.getElementById('licencetype').value,
                    licenceregdate: document.getElementById('licenceregdate').value,
                    cotisationtype: parseInt(document.getElementById('cotisationtype').value) || 0,
                    cotisationpaymentdate: document.getElementById('cotisationpaymentdate').value
                };
                // Supprimer l'entr√©e existante
                await fetch(`${SUPABASE_URL}/rest/v1/licencesetcotisations?boxeur_id=eq.${boxeurId}`, {
                    method: 'DELETE',
                    headers: { "apikey": API_KEY, "Authorization": "Bearer " + API_KEY }
                });
                // Ins√©rer le nouvel enregistrement
                const res = await fetch(`${SUPABASE_URL}/rest/v1/licencesetcotisations`, {
                    method: 'POST',
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': 'Bearer ' + API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(await res.text());
                document.getElementById('result').innerText = "Licence et cotisation mises √† jour";
                loadLicenceCotisation(boxeurId);
                loadBoxeursNotInOrderOptimized();
            } catch (e) {
                console.error(e);
                document.getElementById('result').innerText = "Erreur mise √† jour licence";
            }
        }

        // --- Chargement boxeurs pas en ordre ---
        async function loadBoxeursNotInOrderOptimized() {
            const tbody = document.querySelector('#notInOrderTable tbody');
            tbody.innerHTML = '<tr><td colspan="3">Chargement...</td></tr>';
            try {
                const query = `select=id,LastName,FirstName,licencesetcotisations!left(id,licencetype,licenceregdate,cotisationtype,cotisationpaymentdate)`;
                const res = await fetch(`${SUPABASE_URL}/rest/v1/Boxeurs?${query}`, {
                    headers: { "apikey": API_KEY, "Authorization": "Bearer " + API_KEY }
                });
                const boxeurs = await res.json();
                tbody.innerHTML = '';

                boxeurs.forEach(b => {
                    const l = b.licencesetcotisations && b.licencesetcotisations[0] ? b.licencesetcotisations[0] : null;
                    let licenceStatus = "En cours";
                    let cotisationStatus = "Non pay√©";

                    if (l) {
                        licenceStatus = getLicenceStatusMessage(l.licenceregdate);
                        const type = parseInt(l.cotisationtype) || 0;
                        let expireStr = '';
                        if (type === 3) {
                            expireStr = l.cotisationpaymentdate || new Date().toISOString().split('T')[0];
                        } else if (type > 0 && l.cotisationpaymentdate) {
                            const expire = new Date(l.cotisationpaymentdate);
                            expire.setMonth(expire.getMonth() + type);
                            expireStr = expire.toISOString().split('T')[0];
                        }
                        cotisationStatus = getCotisationStatusMessage(l.cotisationpaymentdate, expireStr);
                    }

                    // Consid√©rer "En cours" comme pas en ordre
                    if (!(licenceStatus === "Valide" && cotisationStatus === "Pay√©")) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${b.LastName} ${b.FirstName}</td><td>${licenceStatus}</td><td>${cotisationStatus}</td>`;
                        tbody.appendChild(tr);
                    }
                });

                if (!tbody.hasChildNodes()) {
                    tbody.innerHTML = '<tr><td colspan="3">Tous les boxeurs sont en ordre üëç</td></tr>';
                }

                addTableSort('#notInOrderTable');

            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="3">Erreur chargement boxeurs</td></tr>';
            }
        }

        // --- Tri dynamique du tableau ---
        function addTableSort(tableSelector) {
            const table = document.querySelector(tableSelector);
            const headers = table.querySelectorAll('th');
            headers.forEach((th, index) => {
                th.addEventListener('click', () => {
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const isAsc = th.classList.contains('asc');
                    rows.sort((a, b) => {
                        const cellA = a.children[index].innerText.toLowerCase();
                        const cellB = b.children[index].innerText.toLowerCase();
                        return cellA.localeCompare(cellB) * (isAsc ? -1 : 1);
                    });
                    tbody.innerHTML = '';
                    rows.forEach(r => tbody.appendChild(r));
                    headers.forEach(h => h.classList.remove('asc', 'desc'));
                    th.classList.toggle('asc', !isAsc);
                    th.classList.toggle('desc', isAsc);
                });
            });
        }

        // --- Initialisation ---
        document.addEventListener('DOMContentLoaded', () => {
            loadBoxeurs();
            document.getElementById('boxeurSelect').addEventListener('change', e => {
                if (e.target.value) loadLicenceCotisation(e.target.value);
            });
            document.getElementById('licencetype').addEventListener('change', updateLicenceStatus);
            document.getElementById('licenceregdate').addEventListener('change', updateLicenceStatus);
            document.getElementById('cotisationtype').addEventListener('change', updateCotisationStatus);
            document.getElementById('cotisationpaymentdate').addEventListener('change', updateCotisationStatus);
            document.getElementById('saveBtn').addEventListener('click', () => {
                const boxeurId = document.getElementById('boxeurSelect').value;
                if (!boxeurId) { alert("Veuillez s√©lectionner un boxeur"); return; }
                saveLicenceCotisation(boxeurId);
            });

            loadBoxeursNotInOrderOptimized();
        });
    </script>
</body>
</html>