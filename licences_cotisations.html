<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boxe Tool - Licences & Cotisations v.024</title>
</head>
<body>

    <h1>Gestion Licences & Cotisations v 0.1</h1>

    <label for="boxeurSelect">Choisissez un boxeur :</label>
    <select id="boxeurSelect">
        <option value="">-- S√©lectionnez --</option>
    </select>

    <!-- Section Licences -->
    <div style="margin-top:15px;">
        <h3>Licence</h3>

        <label>
            Type:
            <select id="licencetype">
                <option value="">-- S√©lectionnez --</option>
                <option value="Boxe Anglaise">Boxe Anglaise</option>
                <option value="Boxe Fran√ßaise">Boxe Fran√ßaise</option>
                <option value="En Cours">En Cours</option>
            </select>
        </label>
        <br>

        <label id="labelRegDate">
            Date r√®glement:
            <input type="date" id="licenceregdate">
        </label>
        <br>

        <label>Status: <span id="licencestatus"></span></label>
        <br>
        <label>Date expiration calcul√©e: <span id="licenceexpiredate" data-prev=""></span></label>
    </div>

    <!-- Section Cotisations -->
    <div style="margin-top:15px;">
        <h3>Cotisation</h3>

        <label>
            Type (s√©ance / mois) :
            <select id="cotisationtype">
                <option value="">‚Äî choisir ‚Äî</option>
                <option value="3">3‚Ç¨</option>
                <option value="1">1 mois</option>
                <option value="5">5 mois</option>
                <option value="10">10 mois</option>
            </select>
        </label>
        <br>

        <label>Pay√©: <span id="cotisationstatus"></span></label>
        <br>

        <label>
            Date paiement:
            <input type="date" id="cotisationpaymentdate">
        </label>
        <br>

        <label>
            Date √©ch√©ance:
            <input type="date" id="cotisationexpiredate">
        </label>
        <br>
    </div>

    <div style="margin-top:10px;">
        <button id="saveBtn">Enregistrer</button>
    </div>

    <div id="result" style="margin-top:20px; font-weight:bold;"></div>

    <script>
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4cmZydG1haGZ5bXd1eGdwcnNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0MDUzMTksImV4cCI6MjA4MDk4MTMxOX0.ge8mWR-cejDTxPC2zTm-Xl1eBma1KWro8-SEzM8zblk';
        const SUPABASE_URL = 'https://uxrfrtmahfymwuxgprsd.supabase.co';

        // üîπ Chargement des boxeurs
        async function loadBoxeurs() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/Boxeurs?select=id,LastName,FirstName`, {
                    headers: { "apikey": API_KEY, "Authorization": "Bearer " + API_KEY }
                });
                const data = await res.json();
                const select = document.getElementById('boxeurSelect');
                data.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.textContent = `${b.LastName} ${b.FirstName}`;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error("Erreur loadBoxeurs", e);
                document.getElementById('result').innerText = "Erreur chargement boxeurs";
            }
        }

        // üîπ Calcul de la date d'expiration
        function calculateLicenceExpireDate(regDateStr) {
            if (!regDateStr) return '';
            const regDate = new Date(regDateStr);
            regDate.setFullYear(regDate.getFullYear() + 1); // +1 an
            return regDate.toISOString().split('T')[0];
        }

        // üîπ Statut licence
        function getLicenceStatus(expireDateStr) {
            if (!expireDateStr) return "En cours";
            const today = new Date().toISOString().split('T')[0];
            return expireDateStr >= today ? "Valide" : "Expir√©e";
        }

        // üîπ Met √† jour le statut et la date calcul√©e
        function updateLicenceStatus() {
            const type = document.getElementById('licencetype').value;
            const regDate = document.getElementById('licenceregdate').value;
            const expireSpan = document.getElementById('licenceexpiredate');
            const labelRegDate = document.getElementById('labelRegDate');

            if (type === "En Cours") {
                labelRegDate.style.display = 'none';
                document.getElementById('licencestatus').innerText = "En cours";
                // Si une expiration pr√©c√©dente existait, on l'affiche
                const prevExpire = expireSpan.getAttribute('data-prev') || '';
                expireSpan.innerText = prevExpire;
            } else {
                labelRegDate.style.display = 'inline';
                const expireDate = calculateLicenceExpireDate(regDate);
                expireSpan.innerText = expireDate;
                document.getElementById('licencestatus').innerText = getLicenceStatus(expireDate);
            }
        }

        // üîπ Chargement licence + cotisation pour un boxeur
        async function loadLicenceCotisation(boxeurId) {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/licencesetcotisations?boxeur_id=eq.${boxeurId}`, {
                    headers: { "apikey": API_KEY, "Authorization": "Bearer " + API_KEY }
                });
                const data = await res.json();

                if (data.length > 0) {
                    const l = data[0];
                    document.getElementById('licencetype').value = l.licencetype || '';
                    document.getElementById('licenceregdate').value = l.licenceregdate || '';

                    // On garde la derni√®re expiration calcul√©e pour "En Cours"
                    const lastExpire = l.licenceregdate ? calculateLicenceExpireDate(l.licenceregdate) : '';
                    document.getElementById('licenceexpiredate').setAttribute('data-prev', lastExpire);

                    updateLicenceStatus();

                    document.getElementById('cotisationtype').value = l.cotisationtype || '';
                    document.getElementById('cotisationstatus').innerText = l.cotisationpaymentdate ? "Pay√©" : "Non pay√©";
                    document.getElementById('cotisationexpiredate').value = l.cotisationexpiredate || '';
                    document.getElementById('cotisationpaymentdate').value = l.cotisationpaymentdate || '';
                } else {
                    document.getElementById('licencetype').value = '';
                    document.getElementById('licenceregdate').value = '';
                    document.getElementById('licencestatus').innerText = '';
                    document.getElementById('licenceexpiredate').innerText = '';
                    document.getElementById('cotisationtype').value = '';
                    document.getElementById('cotisationstatus').innerText = '';
                    document.getElementById('cotisationexpiredate').value = '';
                    document.getElementById('cotisationpaymentdate').value = '';
                }
            } catch (e) {
                console.error("Erreur loadLicenceCotisation", e);
            }
        }

        // üîπ Sauvegarde licence + cotisation (sans expiry date dans la DB)
        async function saveLicenceCotisation(boxeurId) {
            try {
                const payload = {
                    boxeur_id: boxeurId,
                    licencetype: document.getElementById('licencetype').value,
                    licenceregdate: document.getElementById('licenceregdate').value,
                    cotisationtype: parseInt(document.getElementById('cotisationtype').value) || 0,
                    cotisationpaymentdate: document.getElementById('cotisationpaymentdate').value
                };

                await fetch(`${SUPABASE_URL}/rest/v1/licencesetcotisations?boxeur_id=eq.${boxeurId}`, {
                    method: 'DELETE',
                    headers: { "apikey": API_KEY, "Authorization": "Bearer " + API_KEY }
                });

                const res = await fetch(`${SUPABASE_URL}/rest/v1/licencesetcotisations`, {
                    method: 'POST',
                    headers: {
                        'apikey': API_KEY,
                        'Authorization': 'Bearer ' + API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(await res.text());

                document.getElementById('result').innerText = "Licence et cotisation mises √† jour";
                loadLicenceCotisation(boxeurId);

            } catch (e) {
                console.error(e);
                document.getElementById('result').innerText = "Erreur mise √† jour licence";
            }
        }

        // üîπ √âv√©nements
        document.addEventListener('DOMContentLoaded', () => {
            loadBoxeurs();

            document.getElementById('boxeurSelect').addEventListener('change', e => {
                if (e.target.value) loadLicenceCotisation(e.target.value);
            });

            document.getElementById('licenceregdate').addEventListener('change', updateLicenceStatus);
            document.getElementById('licencetype').addEventListener('change', updateLicenceStatus);

            document.getElementById('saveBtn').addEventListener('click', () => {
                const boxeurId = document.getElementById('boxeurSelect').value;
                if (!boxeurId) {
                    alert("Veuillez s√©lectionner un boxeur");
                    return;
                }
                saveLicenceCotisation(boxeurId);
            });
        });
    </script>
</body>
</html>